# RAG Assistant — локальный помощник по файлам (контекстное меню)

Коротко: это приложение индексирует локальные документы (PDF, TXT, DOCX, HTML, MD, PNG/JPG с OCR) и позволяет задавать вопросы по содержимому. Добавлена поддержка контекстного меню Windows (ПКМ) — два пункта: "RAG: Рассказать об этом" и "RAG: Спросить у ассистента" — для файлов и папок.

## Основные возможности

- Индексация папки с документами и хранение индекса в централизованном кеше (не в самой папке).
- Контекстное меню в Проводнике для быстрого запуска в режимах "рассказать" (авто-вопрос) и "спросить" (интерактивный чат).
- При запуске по ПКМ на файл (не папку) — индексируется только этот файл, а не вся папка.
- OCR для изображений через EasyOCR.
- Встроенные инструменты: кнопка очистки кеша, окно просмотра логов, открытие папки кеша.

## Требования

- Windows (рекомендовано).
- Python 3.10+ (примеры ниже для PowerShell). Рекомендуется установить Python с python.org или через winget, а не из Microsoft Store (чтобы кеш был в стандартной папке AppData).
- Рекомендуется виртуальное окружение и установка зависимостей из `requirements.txt`.
- Для локальных моделей — Ollama должен быть запущен (`ollama serve`) и нужные модели должны быть загружены (`ollama pull`).

## Установка зависимостей

1. Создайте и активируйте виртуальное окружение (PowerShell):

```powershell
python -m venv .venv
& .\.venv\Scripts\Activate.ps1
```

2. Установите зависимости:

```powershell
pip install -r requirements.txt
```

## Запуск приложения вручную

- Открыть GUI и начать работу (без указания папки):

```powershell
python .\src\app.py
```

- Открыть GUI и сразу указать папку для индексации:

```powershell
python .\src\app.py "C:\Path\To\Folder"
```

- Запустить в режиме контекстного действия "рассказать" (имитация вызова из Проводника) по **папке**:

```powershell
python .\src\app.py "C:\Path\To\Folder" --tell
```

- Запустить в режиме контекстного действия "рассказать" по **одному файлу** (индексируется только он):

```powershell
python .\src\app.py "C:\Path\To\File.pdf" --tell
```

- Запустить в режиме, где пользователь вводит вопрос вручную:

```powershell
python .\src\app.py "C:\Path\To\FolderOrFile" --ask
```

## Установка пунктов контекстного меню (ПКМ)

Скрипт `scripts/install_context_menu.py` регистрирует два пункта в реестре пользователя (HKCU), без прав администратора:

```powershell
& .\.venv\Scripts\Activate.ps1   # активируйте окружение, чтобы регистрация использовала нужный python
python .\scripts\install_context_menu.py install
```

Пункты создаются для файлов и папок. Скрипт пытается использовать `pythonw.exe` (чтобы не открывать консоль). Если вы хотите видеть логи — запускайте `app.py` вручную (через `python`, а не `pythonw`).

### Удаление пунктов контекстного меню

```powershell
python .\scripts\install_context_menu.py uninstall
```

## Где хранятся кеши и индексы

Все временные файлы и индексы теперь сохраняются централизованно, а не в индексируемой папке. По умолчанию расположение на Windows:

```
%LOCALAPPDATA%\RAGAssistant\<имя_папки>_<hash16>\
```

В этой папке вы увидите `faiss_index/`, `file_timestamps.pkl`, `summary_cache.pkl`, `summary_hash.txt` и т.п. Для удобства, когда вы открываете папку в GUI, путь к кешу выводится в подсказке (tooltip) над меткой папки.

**Примечание**: если `LOCALAPPDATA` не задано, используется `~/.cache/rag_assistant`.

## Тестирование контекстного меню

1. Убедитесь, что вы устанавливали контекстное меню из того же Python/venv, который используете для запуска приложения.
2. Правый клик по файлу или папке → `RAG: Рассказать об этом`. Должно открыться GUI и после индексации приложение автоматически показать краткое резюме.
3. Правый клик → `RAG: Спросить у ассистента`. GUI откроется и фокус перейдёт на поле ввода.

## Советы по отладке

- Если при запуске из контекстного меню появляется окно терминала — это значит, что команда в реестре использует `python.exe`. Переустановите контекстное меню, запустив `install` из venv: он постарается зарегистрировать `pythonw.exe`.
- Если индексация не запускается или нет ответа от модели — убедитесь, что Ollama запущен и модель загружена (`ollama serve` и `ollama pull <model>`).
- Чтобы увидеть логи индексации, запускайте `python .\src\app.py ...` вручную в терминале (не `pythonw`).

## Встроенные инструменты в интерфейсе

### Кнопка "Очистить кеш" (Clear Cache)

- Находится в нижнем правом углу боковой панели (синяя кнопка с градиентом).
- Удаляет кеш и индекс выбранной папки (FAISS, временные файлы, кеши резюме).
- При нажатии выводится диалог подтверждения. Если вы подтверждаете удаление, можно выбрать, нужно ли заново индексировать папку или нет.
- Кнопка активна только после выбора папки.

### Окно "Логи" (Logs Viewer)

- Находится в нижнем левом углу боковой панели (полупрозрачная кнопка).
- Открывает отдельное окно, где в реальном времени отображаются логи индексации и ответов модели.
- Автоматически обновляется каждую секунду, чтобы показывать новые записи.
- Функции кнопок в окне логов:
  - **Обновить** — принудительно перезагрузить содержимое логов.
  - **Очистить лог** — удалить содержимое лог-файла (с подтверждением).
  - **Открыть папку** — открыть папку с логами в Проводнике (Windows: `%LOCALAPPDATA%\RAGAssistant\logs/`).
- Логи полезны для отладки: если индексация зависает или модель не отвечает, обратитесь к логам.

### Индексирование одного файла (без сканирования папки)

- Когда вы запускаете из контекстного меню **на файл** (например, "RAG: Рассказать об этом" по `Document.pdf`), приложение создаёт виртуальную папку с этим одним файлом и индексирует только его.
- Это полезно для больших папок, когда нужно быстро получить информацию из одного документа, не дожидаясь индексирования всей папки.
- Виртуальная папка автоматически очищается при закрытии приложения или пересоздаётся при следующем запуске.

## Опции для продакшна

Для более удобной установки рекомендуется собрать Windows-исполняемый файл (pyinstaller/briefcase) и регистрировать путь к exe в реестре вместо `python.exe`/`pythonw.exe`. Тогда установка будет надёжнее и независима от виртуального окружения.

## Контакты и вклад

Если нужны улучшения (например, экспорт логов, фильтры по типам файлов, интеграция с облачными хранилищами), предложите их.

---
**Автор**: локальная разработка — быстрый RAG-инструмент для поиска по файлам.
